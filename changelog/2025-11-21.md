# Changelog

All notable changes to Flow will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [0.2.0] - 2025-11-21

### Added

#### Networking Layer (libp2p Foundation - Phase 1)
- **libp2p P2P networking stack** with full Kademlia DHT implementation for peer discovery and content routing
- **NetworkManager** abstraction providing clean API for network operations with start/stop lifecycle management
- **Ed25519 to libp2p keypair conversion** enabling existing node keys to work with libp2p
- **Multi-transport support** with QUIC (primary) and TCP fallback for flexible connectivity
- **Noise protocol encryption** with Yamux stream multiplexing for secure connections
- **Persistent DHT store** using RocksDB replacing in-memory store for production readiness
- **Peer registry** with comprehensive connection tracking including:
  - Connection direction (inbound/outbound)
  - Connection statistics (bytes sent/received, latency)
  - Reconnection counting across sessions
  - Peer lifecycle events (established, closed, failed)
- **Network statistics API** exposing peer count, connection stats, and network health metrics
- **Thread-safe concurrent operations** using Arc, RwLock, and mpsc channels for reliable multi-threaded access
- **Comprehensive test suite** for networking components covering concurrent operations, lifecycle management, and edge cases

#### Storage Layer
- **RocksDB-based KV store** replacing Sled with production-grade storage backend featuring:
  - Pluggable storage abstraction via `KvStore` trait
  - Compression support (LZ4) with configurable settings
  - Bloom filters for efficient key lookups
  - Column family support for logical data separation
  - Thread-safe concurrent access
- **RocksDB event store** with complete migration from Sled including:
  - Atomic write operations using WriteBatch
  - Hash chain integrity for event verification
  - Causality tracking with dotted version vectors
  - Content-based deduplication via hash indexing
  - Iterator support for event traversal
- **Peer registry persistence** using RocksDB with column families for:
  - Active peer tracking
  - Known peer addresses
  - Peer statistics and reputation
  - Persistent reconnection counts
- **Unified storage configuration** management with platform-specific data directory support

#### AI Module (Major Refactoring)
- **Modular AI architecture** splitting monolithic 760-line module into 7 focused components
- **Smart language-aware chunking** with tree-sitter support for 15+ programming languages
- **Failure tracking system** with database persistence and configurable thresholds
- **Real-time validation framework** with catastrophic failure detection
- **Background indexing** with non-blocking pipeline execution
- **Comprehensive metrics tracking** using atomic counters for thread-safe monitoring
- **13 comprehensive space API tests** covering creation, validation, and concurrency

#### Testing & Quality
- **Integration test infrastructure** for multi-node scenarios with proper isolation using tempfile
- **Concurrency tests** validating thread-safe operations across all storage layers
- **Serial test execution support** for environment-sensitive tests using serial_test crate
- **Mock implementations** enabling isolated component testing

### Changed

#### Storage Migration
- **Migrated Event Store from Sled to RocksDB** improving performance and reliability
- **Migrated general KV store from Sled to RocksDB** with unified storage backend
- **Replaced MemoryStore with RocksDbStore** in Kademlia DHT for persistent peer routing
- **Updated all test fixtures** to use RocksDB instead of Sled

#### Architecture Improvements
- **Refactored AI module** from `ai_pipeline` to `ai` with clean separation of concerns:
  - `pipeline_manager.rs` (345 lines) - Lifecycle management
  - `pipeline.rs` (342 lines) - Pipeline construction
  - `metrics.rs` (191 lines) - Validation and tracking
  - `config.rs` (173 lines) - Configuration management
  - `smart_chunker.rs` (135 lines) - Intelligent chunking
- **Improved space creation flow** making indexing failures non-fatal for better UX
- **Enhanced runner initialization** with clearer phase separation (infrastructure → services → assembly)
- **Standardized error handling** across all modules using AppError enum
- **Improved logging** with structured telemetry throughout the codebase

#### Performance Optimizations
- **Reduced database lock acquisitions** by 50% in event store operations
- **Background processing** for long-running indexing operations
- **Client connection pooling** for embedding and vector storage
- **Smart chunking with timeout** (30 seconds) preventing indefinite hangs
- **Optimized RocksDB settings** with appropriate compression and buffer sizes

### Fixed

- **Race condition in Event Store** by adding Mutex guard to append operations preventing event overwrites in concurrent scenarios
- **Incorrect embedding model usage** switching from LLM (Ollama) to proper FastEmbed client for embeddings
- **NetworkEventLoop shutdown hang** fixing command handler to properly break event loop on shutdown signal
- **PeerInfo serialization** adding custom serde implementations for PeerId and Multiaddr types
- **Instant/SystemTime conversion** in peer registry correcting time calculations for persistence
- **RocksDB lock conflicts** in parallel tests by using proper tempfile isolation
- **libp2p 0.56 API compatibility** updating to new method signatures and feature flags
- **Connection lifecycle tracking** ensuring reconnection counts persist across disconnections

### Security

- **Noise protocol implementation** providing encrypted peer-to-peer connections
- **Capability-based network access** preparing foundation for Capability-based authorization
- **Secure key storage** with proper Ed25519 key management

### Deprecated

- **Sled database** completely removed in favor of RocksDB
- **MemoryStore for DHT** replaced with persistent RocksDB backend

### Migration Notes

#### Breaking Changes
- **Storage backend change**: Existing Sled databases will not be automatically migrated. Fresh initialization required.
- **Import paths changed**: `ai_pipeline` module renamed to `ai`
- **KV Store API**: `sled::Db` replaced with `Arc<dyn KvStore>` requiring code updates

#### Environment Variables
New variables added:
```bash
# Network Configuration
DHT_DB_PATH=/path/to/dht/db
PEER_REGISTRY_DB_PATH=/path/to/peer/registry
ENABLE_QUIC=true
NETWORK_LISTEN_PORT=0

# KV Store Configuration  
KV_STORE_PATH=/path/to/kv/store
KV_ENABLE_COMPRESSION=true
KV_MAX_OPEN_FILES=1000
KV_WRITE_BUFFER_SIZE=67108864

# AI Module (Failure Thresholds)
MAX_FAILURE_RATE=0.3
CATASTROPHIC_FAILURE_RATE=0.7
MIN_FILES_THRESHOLD=10
```

#### Database Migrations
Run migrations to update database schema:
```bash
cd back-end
sea-orm-cli migrate up
```

New tables:
- `space_index_status` - Tracks indexing progress per space
- Fields added: `files_failed`, `last_error` for failure tracking

---

## [0.1.0] - 2025-10-14

### Added

#### Identity & Authentication (WebAuthn/DID/SSI)
- **WebAuthn authentication system** with complete registration and authentication flows
- **Passkey management** with database persistence and secure credential storage
- **DID (Decentralized Identifier) generation** from passkeys supporting did:key method
- **DID document creation** with JWK public keys and verification relationships
- **Challenge-based authentication** with 5-minute session expiration and replay protection
- **Multi-device support** enabling same user across different devices
- **Database schema** for users and passkeys with proper foreign key relationships

#### REST API
- Authentication endpoints:
  - `GET /api/v1/webauthn/start_registration`
  - `POST /api/v1/webauthn/finish_registration`
  - `POST /api/v1/webauthn/start_authentication`
  - `POST /api/v1/webauthn/finish_authentication`
- Space management endpoints:
  - `POST /api/v1/spaces` - Create new spaces
  - Space indexing and query capabilities

#### Database Layer
- **SeaORM integration** with SQLite backend
- **Migration system** for schema versioning
- **Entity models** for User, PassKey, Space, and SpaceIndexStatus

#### Initial Modules
- **SSI module** with WebAuthn state management and DID utilities
- **Space module** for local directory indexing
- **AI pipeline module** (later refactored) for document indexing

### Initial Release Notes

This release establishes the foundation for Flow's decentralized identity and local-first architecture, implementing passwordless authentication and basic space management capabilities.

---

**Note**: Version 0.2.0 represents a major milestone with complete P2P networking foundation and production-grade storage migration. The system is now ready for distributed operation with proper peer discovery, secure communication, and persistent state management.